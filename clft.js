// ==UserScript==
// @name         clft
// @namespace    violentmonkey
// @version      2.9
// @match        https://my.learnquraan.co.uk/employees/teacher/lesson-step1*
// @match        https://my.learnquraan.co.uk/employees/teacher/lesson-step2*
// @grant        GM.addStyle
// @run-at       document-idle
// ==/UserScript==

(()=>{"use strict";(document.head||document.documentElement).insertAdjacentHTML("beforeend",'<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;600;800&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">');const t=(t,e)=>localStorage.setItem(t,JSON.stringify(e));let e=document.querySelector(".box-title")?.textContent.trim()||"",n="";e&&(location.href.includes("lesson-step1")?n=e.match(/^(.+?)'s\s+Lesson Details$/)?.[1]||"":location.href.includes("lesson-step2")&&(n=e.match(/^(.+?)'s\s+Additional Lesson Details$/)?.[1]||""));const s=n.trim().toLowerCase().replace(/\s+/g," ");if(!n)return;let a=(t=>{try{const e=localStorage.getItem(t);return e?JSON.parse(e):{}}catch{return{}}})("listOfStudents");a&&"object"==typeof a&&!Array.isArray(a)||(a={});let o=a[s]||{name:n,panelOpen:!1,feature:"performance"};a[s]=o,t("listOfStudents",a);let i={};try{i=JSON.parse(localStorage.getItem("lq_features")||"{}")}catch{i={}}i[s]=i[s]||{tasks:[],history:[]};const l=()=>{let t=new Date,e=t.getMinutes()<30?"00":"30";return t.getFullYear()+(""+(t.getMonth()+1)).padStart(2,0)+(""+t.getDate()).padStart(2,0)+(""+t.getHours()).padStart(2,0)+e};let r;try{r=JSON.parse(localStorage.getItem("currentClass"))}catch{}r&&r.student===s&&r.time===l()||(r={student:s,time:l(),complements:{p:Array(9).fill(0),n:Array(9).fill(0)}},localStorage.setItem("currentClass",JSON.stringify(r)));const c={1:"Nice",2:"Good",3:"Cool",4:"Great",5:"Awesome",6:"Amazing",7:"Wow",8:"Marvelous",9:"Spectacular"},d={1:"Oh",2:"Oops",3:"Uh-oh",4:"Hmm",5:"Ehh",6:"Oopsie",7:"Whoops",8:"Aaugh",9:"Yikes"},p={1:"#0f766e",2:"#166534",3:"#1e40af",4:"#b45309",5:"#b91c1c",6:"#be185d",7:"#7c3aed",8:"#6d28d9",9:"#b7791f"},m={1:"#4b5563",2:"#6b7280",3:"#2563eb",4:"#1e40af",5:"#6d28d9",6:"#9d174d",7:"#c026d3",8:"#ef4444",9:"#7f1d1d"};let f={p:{},n:{}},u=50;for(let t=1;t<=9;t++)f.p[t]=r.complements.p[t-1],f.n[t]=r.complements.n[t-1],u+=f.p[t]*t-f.n[t]*t;const h=document.createElement("div");h.id="site",document.body.appendChild(h);const g=document.createElement("div");g.id="panel",g.innerHTML=`<div id=header><div id=name><i class="fa-regular fa-user"></i>${n}</div><div id=timer><i class="fa-regular fa-clock"></i><span>00:00</span></div></div><div id=switcher><button data-f="performance" title="Performance"><i class="fa-solid fa-chart-simple"></i></button><button data-f="results" title="Results"><i class="fa-solid fa-chart-column"></i></button><button data-f="tasks" title="Tasks"><i class="fa-solid fa-list-check"></i></button></div><div id=featureArea><div id=perfContainer><div id=box><div class=l>STUDENT AURA</div><div id=score>${u}</div></div><div id=lists><div><h3>üåü Positive</h3><div id=pos></div></div><div><h3>‚ö†Ô∏è Needs Work</h3><div id=neg></div></div></div></div><div id=featContent style="display:none"></div></div><div id=close>‚úï</div>`,document.body.appendChild(g);const y=document.createElement("div");y.id="mini",y.innerHTML='<i class="fa-solid fa-chart-simple"></i>',document.body.appendChild(y);const x=document.createElement("div");x.id="toast",document.body.appendChild(x),GM.addStyle(":root{--site-width:100%;--pswp-width:100vw}html,body{margin:0;font-family:Play}\nbody{\n  transition:margin-right .35s ease;\n}\nbody.lq-panel-open{\n  margin-right:20vw;\n}\n#panel{position:fixed;right:0;top:0;width:20vw;height:100vh;background:#020617;color:#e5e7eb;padding:14px;display:flex;flex-direction:column;transition:transform .28s ease;z-index:9999}#panel.closed{transform:translateX(100%)}#close{position:absolute;top:8px;right:8px;cursor:pointer;opacity:.4}#header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}#name,#timer{font-size:14px;color:#93c5fd}#timer i{margin-right:6px}#switcher{display:flex;gap:6px;margin-bottom:8px}#switcher button{flex:1;background:transparent;border:1px solid #0b1220;color:#93c5fd;padding:6px;border-radius:8px;cursor:pointer;opacity:.6}#switcher button.active{background:rgba(250,204,21,0.06);color:#facc15;opacity:1;border-color:rgba(250,204,21,0.16)}#featureArea{flex:1;overflow:auto}#perfContainer{display:flex;flex-direction:column;height:100%;justify-content:space-between}.l{font-size:11px;opacity:.6;letter-spacing:.1em}#box{flex:1;text-align:center;margin-top:0;display:flex;flex-direction:column;justify-content:center}#score{position: relative; font-size: 90px; font-weight: 800; color: #facc15;}#lists{margin-top:auto;display:flex;width:100%;gap:8px}#lists>div{width:50%;flex:0 0 47%}#pos,#neg{width:100%}h3{text-align:center;font-size:12px;opacity:.7}.item{margin:4px 0;padding:6px;border-radius:8px;font-size:12px;font-weight:700;text-align:center;cursor:pointer}\n#toast{position:absolute;top:40px;left:50%;transform:translateX(-50%);display:flex;justify-content:center;pointer-events:none;z-index:10000}\n#toast::before{content:attr(data-text);padding:18px 50px;border-radius:28px;font-size:30px;font-weight:800;color:#fff;background:var(--bg);opacity:0;transform:translateY(-20px);transition:.4s}#toast.show::before{opacity:1;transform:none}#mini{position:fixed;top:10px;right:10px;width:34px;height:34px;border-radius:50%;background:#020617;color:#93c5fd;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:9999;box-shadow:0 0 12px rgba(0,0,0,.6)}#featContent{height: 90%; margin-top:6px; display: flex; flex-direction: column;}.lq-task{background:#071025;border:1px solid #122032;border-radius:10px;padding:10px;display:flex;align-items:center;gap:10px;margin-bottom:6px}.lq-task span{flex:1;transition:color .35s linear}.lq-task input{flex:1;background:transparent;border:none;outline:none;color:#facc15}.lq-task i{cursor:pointer;opacity:.6}.lq-bars{flex:1;display:flex;align-items:flex-end;gap:4px;justify-content:center;overflow-x:auto;height:200px;position:relative;width:100%}.lq-bars .bar{width:12px;border-radius:3px;background:linear-gradient(180deg,#facc15,#f59e0b);display:inline-block;position:relative}.lq-bars .bar span{position:absolute;top:-18px;left:50%;transform:translateX(-50%) rotate(90deg);font-size:10px;color:#facc15;font-weight:700}.lq-labels{display:flex;gap:4px;margin-top:4px;justify-content:center;align-items:flex-start}.lq-labels div{writing-mode:vertical-rl; text-align:center;font-size:10px;color:#9ca3af;width:12px}.lq-stats{display:flex;flex-direction:column;gap:6px;margin-bottom:6px}.lq-meta{display:flex;justify-content:space-between;font-size:12px;color:#93c5fd;opacity:.9}.pswp{position:fixed!important;left:0!important;top:0!important;width:var(--pswp-width)!important;height:100vh!important;z-index:9998!important;transition:width .35s ease}.pswp__bg{width:var(--pswp-width)!important;background:rgba(2,6,23,0.92)!important}.pswp__scroll-wrap,.pswp__container,.pswp__item{width:var(--pswp-width)!important;transition:width .35s ease}.pswp__ui{right:auto!important}.pswp__button--fs{display:none!important}");const b=t=>{document.body.classList.toggle("lq-panel-open",t),document.documentElement.style.setProperty("--pswp-width",t?"80vw":"100vw")};g.querySelector("#close").onclick=()=>{g.classList.contains("closed")||(g.classList.add("closed"),y.style.display="flex",o.panelOpen=!1,t("listOfStudents",a),b(!1))},y.onclick=()=>{g.classList.contains("closed")&&(g.classList.remove("closed"),y.style.display="none",o.panelOpen=!0,t("listOfStudents",a),b(!0))};const v=(t,e,n)=>{x.dataset.text=`${t} ${n>0?"+":"-"}${Math.abs(n)}`,x.style.setProperty("--bg",`linear-gradient(135deg,${e},#000a)`),x.classList.add("show"),setTimeout((()=>x.classList.remove("show")),1600);let s=document.createElement("div");s.textContent=(n>0?"+":"-")+Math.abs(n),Object.assign(s.style,{position:"absolute",left:"50%",top:"-20px",transform:"translateX(-50%)",fontSize:"36px",fontWeight:"800",color:e,opacity:"1",transition:"all 1s ease-out"}),w.appendChild(s),requestAnimationFrame((()=>{s.style.top="-60px",s.style.opacity="0"})),setTimeout((()=>w.removeChild(s)),1e3)},w=g.querySelector("#score"),k=g.querySelector("#pos"),S=g.querySelector("#neg"),C=()=>{w.textContent=u,k.innerHTML=S.innerHTML="";for(let t=9;t>0;t--){let e=document.createElement("div");e.className="item",e.style.background=p[t],e.textContent=c[t]+" : "+f.p[t],e.onclick=()=>E(t,0),k.appendChild(e)}for(let t=1;t<=9;t++){let e=document.createElement("div");e.className="item",e.style.background=m[t],e.textContent=d[t]+" : "+f.n[t],e.onclick=()=>E(t,1),S.appendChild(e)}},E=(e,n)=>{const a=n?-e:e;n?(f.n[e]++,r.complements.n[e-1]++,v(d[e],m[e],a)):(f.p[e]++,r.complements.p[e-1]++,v(c[e],p[e],a)),u+=a,((t,e)=>{const n=document.createElement("div");n.textContent=(t>0?"+":"-")+Math.abs(t),Object.assign(n.style,{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-50%) scale(1.2)",fontSize:"48px",fontWeight:"900",color:e,opacity:"1",pointerEvents:"none",zIndex:9999,transition:"all 0.9s ease-out"}),w.appendChild(n),requestAnimationFrame((()=>{n.style.transform="translate(-50%,-180%) scale(1)",n.style.opacity="0"})),setTimeout((()=>w.removeChild(n)),900)})(a,n?m[e]:p[e]),localStorage.setItem("currentClass",JSON.stringify(r)),(()=>{const e=i[s].history,n=e.slice(-1)[0];n&&n.time===r.time?n.score=u:e.push({time:r.time,score:u}),i[s].history=e.slice(-10),t("lq_features",i)})(),C()};let q=!1;const L=()=>{if(q)return;let t=new Date,e=new Date(t);t.getMinutes()<30?e.setMinutes(30,0,0):e.setHours(t.getHours()+1,0,0);let n=e-t;const s=g.querySelector("#timer span");n<=0?(s.textContent="CLASS ENDED",q=!0):s.textContent=String(n/6e4|0).padStart(2,0)+":"+String(n%6e4/1e3|0).padStart(2,0)};setInterval(L,1e3),L(),document.addEventListener("keydown",(t=>{/INPUT|TEXTAREA/.test(t.target.tagName)||!/^[1-9]$/.test(t.key)||E(+t.key,t.altKey)})),C();const A=["#facc15","#fbbf24","#fb923c","#f97316","#ea580c"],N=()=>{const e=g.querySelector("#featContent");e.innerHTML="",(i[s].tasks||[]).forEach(((n,a)=>{const o=document.createElement("div");o.className="lq-task";const l=document.createElement("i");l.className="fa-solid fa-check";const r=document.createElement("span");r.textContent=n.text,r.style.color=A[(n.bad||1)-1];const c=document.createElement("i");c.className="fa-solid fa-xmark",l.onclick=()=>{o.style.opacity=0,setTimeout((()=>{i[s].tasks.splice(a,1),t("lq_features",i),N()}),300)},c.onclick=()=>{n.bad=Math.min(5,(n.bad||1)+1),t("lq_features",i),N()},o.append(l,r,c),e.appendChild(o)}));const n=document.createElement("div");n.className="lq-task";const a=document.createElement("input");a.placeholder="Add task and press Enter",a.onkeydown=e=>{"Enter"===e.key&&a.value.trim()&&(i[s].tasks.push({text:a.value.trim(),bad:1}),t("lq_features",i),N())},n.appendChild(a),e.appendChild(n)},M=e=>{(e=>{g.querySelectorAll("#switcher button").forEach((t=>t.classList.toggle("active",t.dataset.f===e))),o.feature=e,t("listOfStudents",a)})(e);const n=g.querySelector("#perfContainer"),l=g.querySelector("#featContent");"performance"===e?(n.style.display="flex",l.style.display="none",C()):(n.style.display="none",l.style.display="flex","tasks"===e?N():(()=>{const t=g.querySelector("#featContent");t.innerHTML="";const e=(i[s].history||[]).slice(-10);if(!e.length)return void(t.textContent="No history yet for this student.");const n=e.map((t=>t.score||0)),a=Math.max(...n),o=Math.round(n.reduce(((t,e)=>t+e),0)/n.length),l=n.slice(-1)[0],r=document.createElement("div");r.className="lq-stats",r.innerHTML=`<div class=lq-meta><div>Highest: <strong>${a}</strong></div><div>Avg: <strong>${o}</strong></div><div>Recent: <strong>${l}</strong></div></div>`,t.appendChild(r);const c=document.createElement("div");c.className="lq-bars",c.style.width="100%",t.appendChild(c);const d=1.2*Math.max(...n)||1.2*a,p=c.clientWidth,m=e.length,f=Math.min(20,(p-4*(m-1))/m);e.forEach((t=>{const e=document.createElement("div");e.className="bar",e.style.width=f+"px",e.style.height=t.score/d*80+"%";const n=document.createElement("span");n.textContent=t.score,e.appendChild(n),c.appendChild(e)}));const u=document.createElement("div");u.className="lq-labels",t.appendChild(u),e.forEach((t=>{const e=document.createElement("div"),n=t.time||"";let s="";s=n.length>=12?new Date(n.slice(0,4)+"-"+n.slice(4,6)+"-"+n.slice(6,8)).toLocaleDateString("en-US",{month:"short",day:"numeric"}):n,e.textContent=s,e.style.width=f+"px",u.appendChild(e)}))})()),(()=>{const t=!g.classList.contains("closed");document.documentElement.style.setProperty("--pswp-width",t?"80vw":"100vw"),requestAnimationFrame((()=>window.dispatchEvent(new Event("resize"))))})()};g.querySelectorAll("#switcher button").forEach((e=>{e.onclick=()=>{o.feature=e.dataset.f,t("listOfStudents",a),M(e.dataset.f)}})),M(o.feature||"performance"),g.classList.contains("closed")||!o.panelOpen?(g.classList.add("closed"),y.style.display="flex"):(g.classList.remove("closed"),y.style.display="none"),b(!g.classList.contains("closed"))})();
document.addEventListener("keydown",(function(e){["INPUT","TEXTAREA"].includes(document.activeElement.tagName)||("ArrowLeft"===e.key&&(e.preventDefault(),document.querySelector(".fa-arrow-left")?.closest("form")?.submit()),"ArrowRight"===e.key&&(e.preventDefault(),document.querySelector(".fa-arrow-right")?.closest("form")?.submit()))}));

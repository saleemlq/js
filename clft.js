// ==UserScript==
// @name         clft
// @namespace    violentmonkey
// @version      2.8
// @match        https://my.learnquraan.co.uk/employees/teacher/lesson-step1*
// @match        https://my.learnquraan.co.uk/employees/teacher/lesson-step2*
// @grant        GM.addStyle
// @run-at       document-idle
// ==/UserScript==
(()=>{"use strict";(document.head||document.documentElement).insertAdjacentHTML("beforeend",'<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;600;800&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">');let e=e=>{try{return JSON.parse(localStorage.getItem(e)||"[]")}catch{return[]}},t=(e,t)=>localStorage.setItem(e,JSON.stringify(t)),i=new URLSearchParams(location.search).get("history_id")||document.querySelector('input[name="history1"]')?.value||"",s=document.querySelector(".box-title")?.textContent.trim()||"",a="";s&&(location.href.includes("lesson-step1")?a=s.match(/^(.+?)'s\s+Lesson Details$/)?.[1]||"":location.href.includes("lesson-step2")&&(a=s.match(/^(.+?)'s\s+Additional Lesson Details$/)?.[1]||""));let n=e("listOfStudents"),l=n.findIndex(e=>e[i]),o=l>-1?n[l][i]:{name:a,panelOpen:!1,feature:"performance"};"string"==typeof o&&(o={name:o,panelOpen:!1,feature:"performance"}),l>-1?n[l][i]=o:n.push({[i]:o}),t("listOfStudents",n);let r={};try{r=JSON.parse(localStorage.getItem("lq_features")||"{}")}catch{r={}}r[i]=r[i]||{tasks:[],history:[]};let d=()=>{let e=new Date,t=30>e.getMinutes()?"00":"30";return e.getFullYear()+(""+(e.getMonth()+1)).padStart(2,0)+(""+e.getDate()).padStart(2,0)+(""+e.getHours()).padStart(2,0)+t},p;try{p=JSON.parse(localStorage.getItem("currentClass"))}catch{}p&&p.history_id===i&&p.time===d()||(p={history_id:i,time:d(),complements:{p:Array(9).fill(0),n:Array(9).fill(0)}},localStorage.setItem("currentClass",JSON.stringify(p)));let c={1:"Nice",2:"Good",3:"Cool",4:"Great",5:"Awesome",6:"Amazing",7:"Wow",8:"Marvelous",9:"Spectacular"},f={1:"Oh",2:"Oops",3:"Uh-oh",4:"Hmm",5:"Ehh",6:"Oopsie",7:"Whoops",8:"Aaugh",9:"Yikes"},$={1:"#0f766e",2:"#166534",3:"#1e40af",4:"#b45309",5:"#b91c1c",6:"#be185d",7:"#7c3aed",8:"#6d28d9",9:"#b7791f"},m={1:"#4b5563",2:"#6b7280",3:"#2563eb",4:"#1e40af",5:"#6d28d9",6:"#9d174d",7:"#c026d3",8:"#ef4444",9:"#7f1d1d"},h={p:{},n:{}},u=50;for(let y=1;y<=9;y++)h.p[y]=p.complements.p[y-1],h.n[y]=p.complements.n[y-1],u+=h.p[y]*y-h.n[y]*y;let g=document.createElement("div");g.id="site",document.body.appendChild(g);let x=document.createElement("div");x.id="panel",x.innerHTML=`<div id=header><div id=name><i class="fa-regular fa-user"></i>${a}</div><div id=timer><i class="fa-regular fa-clock"></i><span>00:00</span></div></div><div id=switcher><button data-f="performance" title="Performance"><i class="fa-solid fa-chart-simple"></i></button><button data-f="results" title="Results"><i class="fa-solid fa-chart-column"></i></button><button data-f="tasks" title="Tasks"><i class="fa-solid fa-list-check"></i></button></div><div id=featureArea><div id=perfContainer><div id=box><div class=l>STUDENT AURA</div><div id=score>${u}</div></div><div id=lists><div><h3>üåü Positive</h3><div id=pos></div></div><div><h3>‚ö†Ô∏è Needs Work</h3><div id=neg></div></div></div></div><div id=featContent style="display:none"></div></div><div id=close>‚úï</div>`,document.body.appendChild(x);let _=document.createElement("div");_.id="mini",_.innerHTML='<i class="fa-solid fa-chart-simple"></i>',document.body.appendChild(_);let b=document.createElement("div");b.id="toast",document.body.appendChild(b),GM.addStyle(`:root{--site-width:100%;--pswp-width:100vw}html,body{margin:0;font-family:Play}body{transition:margin-right .35s ease;}body.lq-panel-open{margin-right:20vw;}#panel{position:fixed;right:0;top:0;width:20vw;height:100vh;background:#020617;color:#e5e7eb;padding:14px;display:flex;flex-direction:column;transition:transform .28s ease;z-index:9999}#panel.closed{transform:translateX(100%)}#close{position:absolute;top:8px;right:8px;cursor:pointer;opacity:.4}#header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}#name,#timer{font-size:14px;color:#93c5fd}#timer i{margin-right:6px}#switcher{display:flex;gap:6px;margin-bottom:8px}#switcher button{flex:1;background:transparent;border:1px solid #0b1220;color:#93c5fd;padding:6px;border-radius:8px;cursor:pointer;opacity:.6}#switcher button.active{background:rgba(250,204,21,0.06);color:#facc15;opacity:1;border-color:rgba(250,204,21,0.16)}#featureArea{flex:1;overflow:auto}#perfContainer{display:flex;flex-direction:column;height:100%;justify-content:space-between}.l{font-size:11px;opacity:.6;letter-spacing:.1em}#box{flex:1;text-align:center;margin-top:0;display:flex;flex-direction:column;justify-content:center}#score{position: relative; font-size: 90px; font-weight: 800; color: #facc15;}#lists{margin-top:auto;display:flex;width:100%;gap:8px}#lists>div{width:50%;flex:0 0 47%}#pos,#neg{width:100%}h3{text-align:center;font-size:12px;opacity:.7}.item{margin:4px 0;padding:6px;border-radius:8px;font-size:12px;font-weight:700;text-align:center;cursor:pointer}#toast{position:absolute;top:40px;left:50%;transform:translateX(-50%);display:flex;justify-content:center;pointer-events:none;z-index:10000}#toast::before{content:attr(data-text);padding:18px 50px;border-radius:28px;font-size:30px;font-weight:800;color:#fff;background:var(--bg);opacity:0;transform:translateY(-20px);transition:.4s}#toast.show::before{opacity:1;transform:none}#mini{position:fixed;top:10px;right:10px;width:34px;height:34px;border-radius:50%;background:#020617;color:#93c5fd;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:9999;box-shadow:0 0 12px rgba(0,0,0,.6)}#featContent{height: 90%; margin-top:6px; display: flex; flex-direction: column;}.lq-task{background:#071025;border:1px solid #122032;border-radius:10px;padding:10px;display:flex;align-items:center;gap:10px;margin-bottom:6px}.lq-task span{flex:1;transition:color .35s linear}.lq-task input{flex:1;background:transparent;border:none;outline:none;color:#facc15}.lq-task i{cursor:pointer;opacity:.6}.lq-bars{flex:1;display:flex;align-items:flex-end;gap:4px;justify-content:center;overflow-x:auto;height:200px;position:relative;width:100%}.lq-bars .bar{width:12px;border-radius:3px;background:linear-gradient(180deg,#facc15,#f59e0b);display:inline-block;position:relative}.lq-bars .bar span{position:absolute;top:-18px;left:50%;transform:translateX(-50%) rotate(90deg);font-size:10px;color:#facc15;font-weight:700}.lq-labels{display:flex;gap:4px;margin-top:4px;justify-content:center;align-items:flex-start}.lq-labels div{writing-mode:vertical-rl; text-align:center;font-size:10px;color:#9ca3af;width:12px}.lq-stats{display:flex;flex-direction:column;gap:6px;margin-bottom:6px}.lq-meta{display:flex;justify-content:space-between;font-size:12px;color:#93c5fd;opacity:.9}.pswp{position:fixed!important;left:0!important;top:0!important;width:var(--pswp-width)!important;height:100vh!important;z-index:9998!important;transition:width .35s ease}.pswp__bg{width:var(--pswp-width)!important;background:rgba(2,6,23,0.92)!important}.pswp__scroll-wrap,.pswp__container,.pswp__item{width:var(--pswp-width)!important;transition:width .35s ease}.pswp__ui{right:auto!important}.pswp__button--fs{display:none!important}`);let v=e=>{document.body.classList.toggle("lq-panel-open",e),document.documentElement.style.setProperty("--pswp-width",e?"80vw":"100vw")},w=()=>{let e=!x.classList.contains("closed");document.documentElement.style.setProperty("--pswp-width",e?"80vw":"100vw"),requestAnimationFrame(()=>window.dispatchEvent(new Event("resize")))},k=()=>{x.classList.contains("closed")&&(x.classList.remove("closed"),_.style.display="none",o.panelOpen=!0,t("listOfStudents",n),v(!0))},C=()=>{x.classList.contains("closed")||(x.classList.add("closed"),_.style.display="flex",o.panelOpen=!1,t("listOfStudents",n),v(!1))};x.querySelector("#close").onclick=C,_.onclick=k;let E=(e,t,i)=>{b.dataset.text=`${e} ${i>0?"+":"-"}${Math.abs(i)}`,b.style.setProperty("--bg",`linear-gradient(135deg,${t},#000a)`),b.classList.add("show"),setTimeout(()=>b.classList.remove("show"),1600);let s=document.createElement("div");s.textContent=(i>0?"+":"-")+Math.abs(i),Object.assign(s.style,{position:"absolute",left:"50%",top:"-20px",transform:"translateX(-50%)",fontSize:"36px",fontWeight:"800",color:t,opacity:"1",transition:"all 1s ease-out"}),q.appendChild(s),requestAnimationFrame(()=>{s.style.top="-60px",s.style.opacity="0"}),setTimeout(()=>q.removeChild(s),1e3)},q=x.querySelector("#score"),S=x.querySelector("#pos"),L=x.querySelector("#neg"),z=()=>{q.textContent=u,S.innerHTML=L.innerHTML="";for(let e=9;e>0;e--){let t=document.createElement("div");t.className="item",t.style.background=$[e],t.textContent=c[e]+" : "+h.p[e],t.onclick=()=>O(e,0),S.appendChild(t)}for(let i=1;i<=9;i++){let s=document.createElement("div");s.className="item",s.style.background=m[i],s.textContent=f[i]+" : "+h.n[i],s.onclick=()=>O(i,1),L.appendChild(s)}},N=()=>{r[i]=r[i]||{tasks:[],history:[]};let e=r[i].history,s=e.slice(-1)[0];s&&s.time===p.time?s.score=u:e.push({time:p.time,score:u}),r[i].history=e.slice(-10),t("lq_features",r)},A=(e,t)=>{let i=document.createElement("div");i.textContent=(e>0?"+":"-")+Math.abs(e),Object.assign(i.style,{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-50%) scale(1.2)",fontSize:"48px",fontWeight:"900",color:t,opacity:"1",pointerEvents:"none",zIndex:9999,transition:"all 0.9s ease-out"}),q.appendChild(i),requestAnimationFrame(()=>{i.style.transform="translate(-50%,-180%) scale(1)",i.style.opacity="0"}),setTimeout(()=>q.removeChild(i),900)},O=(e,t)=>{let i=t?-e:e;t?(h.n[e]++,p.complements.n[e-1]++,E(f[e],m[e],i)):(h.p[e]++,p.complements.p[e-1]++,E(c[e],$[e],i)),u+=i,A(i,t?m[e]:$[e]),localStorage.setItem("currentClass",JSON.stringify(p)),N(),z()},T=!1,H=()=>{if(T)return;let e=new Date,t=new Date(e);30>e.getMinutes()?t.setMinutes(30,0,0):t.setHours(e.getHours()+1,0,0);let i=t-e,s=x.querySelector("#timer span");i<=0?(s.textContent="CLASS ENDED",T=!0):s.textContent=String(i/6e4|0).padStart(2,0)+":"+String(i%6e4/1e3|0).padStart(2,0)};setInterval(H,1e3),H(),document.addEventListener("keydown",e=>{/INPUT|TEXTAREA/.test(e.target.tagName)||!/^[1-9]$/.test(e.key)||O(+e.key,e.altKey)}),z();let M=e=>{x.querySelectorAll("#switcher button").forEach(t=>t.classList.toggle("active",t.dataset.f===e)),o.feature=e,t("listOfStudents",n)},j=["#facc15","#fbbf24","#fb923c","#f97316","#ea580c"],I=()=>{let e=x.querySelector("#featContent");e.innerHTML="",(r[i].tasks||[]).forEach((s,a)=>{let n=document.createElement("div");n.className="lq-task";let l=document.createElement("i");l.className="fa-solid fa-check";let o=document.createElement("span");o.textContent=s.text,o.style.color=j[(s.bad||1)-1];let d=document.createElement("i");d.className="fa-solid fa-xmark",l.onclick=()=>{n.style.opacity=0,setTimeout(()=>{r[i].tasks.splice(a,1),t("lq_features",r),I()},300)},d.onclick=()=>{s.bad=Math.min(5,(s.bad||1)+1),t("lq_features",r),I()},n.append(l,o,d),e.appendChild(n)});let s=document.createElement("div");s.className="lq-task";let a=document.createElement("input");a.placeholder="Add task and press Enter",a.onkeydown=e=>{"Enter"===e.key&&a.value.trim()&&(r[i].tasks.push({text:a.value.trim(),bad:1}),t("lq_features",r),I())},s.appendChild(a),e.appendChild(s)},P=()=>{let e=x.querySelector("#featContent");e.innerHTML="";let t=(r[i].history||[]).slice(-10);if(!t.length){e.textContent="No history yet for this student.";return}let s=t.map(e=>e.score||0),a=Math.max(...s),n=Math.round(s.reduce((e,t)=>e+t,0)/s.length),l=s.slice(-1)[0],o=document.createElement("div");o.className="lq-stats",o.innerHTML=`<div class=lq-meta><div>Highest: <strong>${a}</strong></div><div>Avg: <strong>${n}</strong></div><div>Recent: <strong>${l}</strong></div></div>`,e.appendChild(o);let d=document.createElement("div");d.className="lq-bars",d.style.width="100%",e.appendChild(d);let p=1.2*Math.max(...s)||1.2*a,c=d.clientWidth,f=t.length,$=Math.min(20,(c-4*(f-1))/f);t.forEach(e=>{let t=document.createElement("div");t.className="bar",t.style.width=$+"px",t.style.height=e.score/p*80+"%";let i=document.createElement("span");i.textContent=e.score,t.appendChild(i),d.appendChild(t)});let m=document.createElement("div");m.className="lq-labels",e.appendChild(m),t.forEach(e=>{let t=document.createElement("div"),i=e.time||"",s="";if(i.length>=12){let a=new Date(i.slice(0,4)+"-"+i.slice(4,6)+"-"+i.slice(6,8));s=a.toLocaleDateString("en-US",{month:"short",day:"numeric"})}else s=i;t.textContent=s,t.style.width=$+"px",m.appendChild(t)})},D=e=>{M(e);let t=x.querySelector("#perfContainer"),i=x.querySelector("#featContent");"performance"===e?(t.style.display="flex",i.style.display="none",z()):(t.style.display="none",i.style.display="flex","tasks"===e?I():P()),w()};x.querySelectorAll("#switcher button").forEach(e=>{e.onclick=()=>{o.feature=e.dataset.f,t("listOfStudents",n),D(e.dataset.f)}}),D(o.feature||"performance"),x.classList.contains("closed")||!o.panelOpen?(x.classList.add("closed"),_.style.display="flex"):(x.classList.remove("closed"),_.style.display="none"),v(!x.classList.contains("closed"))})();
